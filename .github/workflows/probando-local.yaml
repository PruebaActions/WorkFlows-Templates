name: "IIS WebDeploy Incremental (Multi-Project with Subfolders)"

on:
  workflow_call:
    inputs:
      projects_json:
        required: true
        type: string
      runner_tag:
        required: true
        type: string
      e2e_tests_json:
        required: false
        type: string
      skip_items_json:
        required: false
        type: string
      e2e_smoke_tests_json:
        required: false
        type: string

jobs:
  # # =======================================
  # # 1Ô∏è‚É£ BUILD PROJECTS
  # # =======================================
  build_projects:
    name: "üî® Build Projects"
    runs-on: [self-hosted, windows, x64, laptop]
    strategy:
      matrix: ${{ fromJson(inputs.projects_json) }}
      max-parallel: 1
    steps:
      - uses: actions/checkout@v4

      - name: "Build with composite action (isolated output)"
        uses: PruebaActions/WorkFlows-Templates/.github/actions/build-release-deploy@main
        with:
          solution_path: ${{ matrix.solution_path }}
          project_path: ${{ matrix.project_path }}
          project_type: ${{ matrix.project_type }}
          output_path: ${{ github.workspace }}/publish/${{ matrix.project_name }}

      - name: "Upload Artifact (per project)"
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.project_name }}
          path: ${{ github.workspace }}/publish/${{ matrix.project_name }}


  # =======================================
  # 3Ô∏è‚É£ DEPLOY TO TEST SITE
  # =======================================
  deploy_to_site_test:
    name: "Deploy to testing site in IIS"
    needs: build_projects
    runs-on: ${{ fromJson(inputs.runner_tag) }}
    strategy:
      matrix: ${{ fromJson(inputs.projects_json) }}
      max-parallel: 1
    steps:
      - name: "Skip deploy in Development"
        if: github.ref == 'refs/heads/Development'
        run: |
          Write-Host "Development branch detected. Skipping deploy to test IIS site."
      
      - name: Checkout repository
        if: ${{ contains(inputs.projects_json, 'deploy_testing_path') && github.ref == 'refs/heads/Production' }}
        uses: actions/checkout@v4

      - name: "Download Artifact (specific project)"
        if: ${{ contains(inputs.projects_json, 'deploy_testing_path') && github.ref == 'refs/heads/Production' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.project_name }}
          path: ${{ github.workspace }}/artifact/${{ matrix.project_name }}

      - name: "Deploy to Test IIS Site"
        if: ${{ contains(inputs.projects_json, 'deploy_testing_path') && github.ref == 'refs/heads/Production' }}
        shell: pwsh
        run: |
          $publishPath = "$env:GITHUB_WORKSPACE\artifact\${{ matrix.project_name }}"
          $siteTestPath = "${{ matrix.deploy_testing_path }}"
          $msdeploy = "C:\Program Files (x86)\IIS\Microsoft Web Deploy V3\msdeploy.exe"
          if (-Not (Test-Path $msdeploy)) {
            $msdeploy = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe"
          }

          #Construir din√°micamente los argumentos -skip basados en tipo real (folder vs file)
          $skipArgs = @()
          $skipItems = '${{ inputs.skip_items_json }}'

          if ($skipItems -ne '') {
            $items = $skipItems | ConvertFrom-Json
            foreach ($name in $items) {
              $fullPath = Join-Path $publishPath $name
              if (Test-Path $fullPath -PathType Container) {
                #Es una carpeta real
                $skipArgs += "-skip:objectName=dirPath,absolutePath='.*[\\/]({0})($|[\\/])'".Replace("{0}", [Regex]::Escape($name))
              } elseif (Test-Path $fullPath -PathType Leaf) {
                #Es un archivo real
                $skipArgs += "-skip:objectName=filePath,absolutePath='.*[\\/]{0}$'".Replace("{0}", [Regex]::Escape($name))
              } else {
                Write-Warning "No se encontr√≥ '$name' dentro de $publishPath ‚Äî ignorando detecci√≥n de tipo."
              }
            }
          }

          Write-Host "Deploying ${{ matrix.project_name }} to $destPath"
          Write-Host "Source: $publishPath"
          Write-Host "Skip arguments: $($skipArgs -join ' ')"

          Write-Host "Deploying from $publishPath to $siteTestPath"
          & $msdeploy `
            -verb:sync `
            -source:dirPath="$publishPath" `
            -dest:dirPath="$siteTestPath" `
            @skipArgs `
            -useCheckSum `
            -allowUntrusted `
            -enableRule:AppOffline `
            -enableRule:DoNotDeleteRule `
            -retryAttempts:3 `
            -verbose


          if ($LASTEXITCODE -ne 0) {
            Write-Host "Deployment failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          } else {
            Write-Host "Deployment completed successfully."
          }

  # =======================================
  # 4Ô∏è‚É£ RUN E2E TESTS
  # =======================================
  run_e2e_tests:
    name: "Run E2E Tests"
    needs: deploy_to_site_test
    runs-on: ${{ fromJson(inputs.runner_tag) }}
    strategy:
      matrix:
        test_command: ${{ fromJson(inputs.e2e_tests_json) }}
    steps:
      - name: "Check if running in Development"
        if: github.ref == 'refs/heads/Development'
        run: |
          Write-Host "Development branch detected. Skipping real E2E tests."

      - name: "Run Maven test"
        if: github.ref == 'refs/heads/Production' && inputs.e2e_tests_json != ''
        shell: pwsh
        run: |
          Write-Host "Running: ${{ matrix.test_command }}"
          & ${{ matrix.test_command }}
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Tests passed successfully."
          } else {
            Write-Error "Tests failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          }


  # # =======================================
  # 2Ô∏è‚É£ CREATE BACKUP
  # =======================================
  prepare_backup:
    name: "Create Backup"
    needs: [build_projects, run_e2e_tests]
    if: >
      ${{
        (github.ref == 'refs/heads/Production' && 
         (needs.build_projects.result == 'success') && 
         (needs.run_e2e_tests.result == 'success')) ||
        (github.ref == 'refs/heads/Development' &&
         (needs.build_projects.result == 'success'))
      }}
    runs-on: ${{ fromJson(inputs.runner_tag) }}
    strategy:
      matrix: ${{ fromJson(inputs.projects_json) }}
      max-parallel: 1
    steps:
      - name: "Create Dynamic Backup Folder"
        id: create_backup
        shell: pwsh
        run: |
          $deployPath = "${{ matrix.deploy_target_path }}"
          $parentDir = Split-Path $deployPath -Parent
          $backupRoot = Join-Path $parentDir "backups"

          if (!(Test-Path $backupRoot)) {
            New-Item -ItemType Directory -Path $backupRoot | Out-Null
          }

          $rawName = Split-Path $deployPath -Leaf
          $siteName = ($rawName -replace "-\d{4}-\d{2}-\d{2}-\d+$", "")

          #Obtener la √∫ltima fecha y hora de modificaci√≥n del deployment actual
          if (Test-Path $deployPath) {
            $lastModifiedItem = Get-ChildItem -Recurse -Path $deployPath -ErrorAction SilentlyContinue |
              Sort-Object LastWriteTime -Descending |
              Select-Object -First 1

            if ($lastModifiedItem) {
              $dateTime = $lastModifiedItem.LastWriteTime.ToString("yyyy-MM-dd")
              Write-Host "√öltima modificaci√≥n detectada: $dateTime"
            } else {
              Write-Host "No se encontraron archivos dentro del deployment. Usando fecha actual."
              $dateTime = (Get-Date).ToString("yyyy-MM-dd")
            }
          } else {
            Write-Host "Ruta de deployment no encontrada. Usando fecha actual."
            $dateTime = (Get-Date).ToString("yyyy-MM-dd")
          }

          # Crear nombre versionado para el backup con la fecha + hora del √∫ltimo cambio
          $i = 1
          while (Test-Path "$backupRoot\$siteName-$dateTime-$i") { $i++ }
          $backupFolder = "$backupRoot\$siteName-$dateTime-$i"

          Write-Host "Creando carpeta de backup: $backupFolder"
          New-Item -ItemType Directory -Path $backupFolder | Out-Null

          if (Test-Path $deployPath) {
            Write-Host "Copiando desde $deployPath ‚Üí $backupFolder"
            Copy-Item -Path "$deployPath\*" -Destination $backupFolder -Recurse -Force
            Write-Host "Backup completado con √©xito."
          } else {
            Write-Host "No se encontr√≥ el deployment original, no se gener√≥ backup."
          }

  # =======================================
  # 5Ô∏è‚É£ DEPLOY TO IIS
  # =======================================
  deploy_to_iis:
    name: "Deploy to IIS"
    needs: [prepare_backup, run_e2e_tests]
    if: >
      ${{
        (github.ref == 'refs/heads/Production' &&
         needs.prepare_backup.result == 'success' &&
         needs.run_e2e_tests.result == 'success') ||
        (github.ref == 'refs/heads/Development' &&
         needs.prepare_backup.result == 'success')
      }}
    runs-on: ${{ fromJson(inputs.runner_tag) }}
    strategy:
      matrix: ${{ fromJson(inputs.projects_json) }}
      max-parallel: 1
    steps:
      - uses: actions/checkout@v4

      - name: "Download Artifact (specific project)"
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.project_name }}
          path: ${{ github.workspace }}/artifact/${{ matrix.project_name }}

      - name: "Deploy to IIS"
        shell: pwsh
        run: |
          $publishPath = "$env:GITHUB_WORKSPACE\artifact\${{ matrix.project_name }}"
          $destPath = "${{ matrix.deploy_target_path }}"
          $msdeploy = "C:\Program Files (x86)\IIS\Microsoft Web Deploy V3\msdeploy.exe"
          if (-Not (Test-Path $msdeploy)) { $msdeploy = "C:\Program Files\IIS\Microsoft Web Deploy V3\msdeploy.exe" }

          #Construir din√°micamente los argumentos -skip basados en tipo real (folder vs file)
          $skipArgs = @()
          $skipItems = '${{ inputs.skip_items_json }}'

          if ($skipItems -ne '') {
            $items = $skipItems | ConvertFrom-Json
            foreach ($name in $items) {
              $fullPath = Join-Path $publishPath $name
              if (Test-Path $fullPath -PathType Container) {
                #Es una carpeta real
                $skipArgs += "-skip:objectName=dirPath,absolutePath='.*[\\/]({0})($|[\\/])'".Replace("{0}", [Regex]::Escape($name))
              } elseif (Test-Path $fullPath -PathType Leaf) {
                #Es un archivo real
                $skipArgs += "-skip:objectName=filePath,absolutePath='.*[\\/]{0}$'".Replace("{0}", [Regex]::Escape($name))
              } else {
                Write-Warning "‚ö†Ô∏è No se encontr√≥ '$name' dentro de $publishPath ‚Äî ignorando detecci√≥n de tipo."
              }
            }
          }

          Write-Host "Deploying ${{ matrix.project_name }} to $destPath"
          Write-Host "Source: $publishPath"
          Write-Host "Skip arguments: $($skipArgs -join ' ')"

          & $msdeploy `
            -verb:sync `
            -source:dirPath="$publishPath" `
            -dest:dirPath="$destPath" `
            @skipArgs `
            -useCheckSum `
            -allowUntrusted `
            -enableRule:AppOffline `
            -enableRule:DoNotDeleteRule `
            -retryAttempts:3 `
            -verbose
          
          if ($LASTEXITCODE -ne 0) {
            Write-Host "Deployment failed with exit code $LASTEXITCODE"
            exit $LASTEXITCODE
          } else {
            Write-Host "Deployment completed successfully."
          }
          
  run_smoke_tests:
      name: "Run Smoke Tests"
      needs: deploy_to_iis
      if: ${{ github.ref == 'refs/heads/Production' && inputs.e2e_smoke_tests_json != '' }}
      runs-on: ${{ fromJson(inputs.runner_tag) }}
      strategy:
        matrix:
          test_command: ${{ fromJson(inputs.e2e_smoke_tests_json) }}
      steps:
        - name: "Run Maven test"
          shell: pwsh
          run: |
            Write-Host "Running: ${{ matrix.test_command }}"
            & ${{ matrix.test_command }}
            if ($LASTEXITCODE -eq 0) {
              Write-Host "Tests passed successfully."
            } else {
              Write-Error "Tests failed with exit code $LASTEXITCODE"
              exit $LASTEXITCODE
            }
