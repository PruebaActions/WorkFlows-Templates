name: Build ClickOnce Template

on:
  workflow_call:
    secrets:
      CERT_PASSWORD_SALES:
        required: false
    inputs:
      projects_json:
        required: false
        type: string
      runner_tag:
        required: false
        type: string
      skip_items_json:
        description: "JSON array of files/folders to skip during msdeploy"
        required: false
        default: "[]"
        type: string
      project_compile_info_json:
        required: false
        type: string

jobs:
  # sql_checkout:
  #   name: "Checkout SQL branch and list files"
  #   runs-on:
  #     group: SQL-Runner
  #   steps:
  #     - name: Checkout Sql branch
  #       uses: actions/checkout@v4
  #       with:
  #         ref: Sql

  #     - name: List files in Sql branch
  #       shell: powershell
  #       run: |
  #         sqlcmd -S localhost -Q "USE AFIFSALESUVC; SELECT * FROM dbo.SurveySections;"
          
  build_clickonce:
    name: "Modify Files & Build ClickOnce"
    runs-on:
        group: DAST
    strategy:
      matrix: ${{ fromJson(inputs.project_compile_info_json) }}
      max-parallel: 1
    env:
      CERT_PASSWORD_SALES: ${{ secrets.CERT_PASSWORD_SALES }}
    # needs: sql_scripts_execution
    # if: ${{ needs.sql_scripts_execution.outputs.success == 'true' }}

    steps:
      - name: Checkout current branch
        uses: actions/checkout@v4
        # with:
        #   ref: ${{ github.ref_name }}

      - name: Generate dynamic version
        id: version
        shell: powershell
        run: |
          $today = Get-Date -Format "yyyy.MM.dd"
          $runCounterFile = "$env:GITHUB_WORKSPACE/.run-counter"

          if (Test-Path $runCounterFile) {
          $lastLine = Get-Content $runCounterFile | Select-Object -Last 1
          $parts = $lastLine -split '\.'
          $lastDate = ($parts[0..2] -join '.')
          $lastRun = [int]$parts[3]

          if ($lastDate -eq $today) {
            $runNumber = $lastRun + 1
          } else {
            $runNumber = 1
          }
          } else {
          $runNumber = 1
          }

          $version = "$today.$runNumber"
          Write-Host "Generated version: $version"

          # Sobrescribe el archivo con la √∫ltima versi√≥n generada
          $version | Out-File -FilePath $runCounterFile -Encoding UTF8

          # Exporta la variable al pipeline
          echo "appVersion=$version" >> $env:GITHUB_OUTPUT

      - name: Replace App.config
        shell: powershell
        run: |
          $source = "${{ matrix.appConfigPath }}"
          $destination = "${{ matrix.dest_appConfig_path }}"

          if (Test-Path $source) {
            Write-Host "Replacing App.config with $source"
            Copy-Item -Path $source -Destination $destination -Force
          } else {
            Write-Error "App.config not found: $source"
            exit 1
          }

      - name: Update AssemblyInfo version
        shell: powershell
        run: |
          $assemblyInfo = "${{ matrix.assemblyInfo_path }}"
          $assemblyVersion = "${{ matrix.assemblyVersion }}"
          $appVersion = "${{ steps.version.outputs.appVersion }}"
          Write-Host "Updating AssemblyVersion to $assemblyVersion"
          Write-Host "Updating FileVersion to $appVersion"

          (Get-Content $assemblyInfo) |
            ForEach-Object {
              $_ -replace 'AssemblyVersion\(".*"\)', "AssemblyVersion(`"$assemblyVersion`")" `
                 -replace 'AssemblyFileVersion\(".*"\)', "AssemblyFileVersion(`"$appVersion`")"
            } | Set-Content $assemblyInfo

      - name: Validate publish directory
        shell: powershell
        run: |
          if (-not (Test-Path "${{ matrix.publishDir }}")) {
            Write-Host "Creating publish directory..."
            New-Item -ItemType Directory -Force -Path "${{ matrix.publishDir }}"
          }

      - name: Restore NuGet packages
        run: nuget restore "${{ matrix.sln_path }}"
      
      - name: Build Project (without publish)
        shell: powershell
        run: |
          Write-Host "Building project without publishing..."
          
          msbuild '${{ matrix.project_path }}' `
            /t:Build `
            /p:Configuration='Release' `
            /p:Platform='Any CPU' `
            /p:OutputPath='bin\Release' `
            /p:PublishUrl="C:\Publish" `
            /v:minimal
          
          Write-Host "Build completed"

      - name: Obfuscate Assembly
        shell: powershell
        run: |
          $obfuscarPath = "C:\Users\Administrator\AppData\Local\Microsoft\VisualStudio\17.0_6d29ba01\Extensions\lf44xtf1.gdm\files\Obfuscar.Console.exe"
    
          if (-not (Test-Path $obfuscarPath)) {
            Write-Host "Buscando Obfuscar..."
            $obfuscarPath = Get-ChildItem "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\IDE\Extensions" -Recurse -Filter "Obfuscar.Console.exe" -ErrorAction SilentlyContinue | Select-Object -First 1 -ExpandProperty FullName
          }
          
          if (-not $obfuscarPath) {
            Write-Error "Obfuscar no encontrado"
            exit 1
          }
          
          Write-Host "Obfuscar: $obfuscarPath"
          
          $projectPath = Resolve-Path '${{ matrix.project_path }}'
          $projectDir = Split-Path $projectPath -Parent
          $binRelease = Join-Path $projectDir "bin\Release"
          
          Write-Host "Directorio del proyecto: $projectDir"
          Write-Host "Directorio de binarios: $binRelease"
          
          if (-not (Test-Path $binRelease)) {
            Write-Error "El directorio de binarios no existe: $binRelease"
            exit 1
          }
          
          Write-Host "Archivos en bin\Release antes de obfuscar:"
          Get-ChildItem $binRelease -Filter "*.exe" | ForEach-Object { Write-Host "  EXE: $($_.Name) - $([math]::Round($_.Length/1KB, 2)) KB" }
          Get-ChildItem $binRelease -Filter "*.dll" | ForEach-Object { Write-Host "  DLL: $($_.Name) - $([math]::Round($_.Length/1KB, 2)) KB" }
          Write-Host ""
          
          $xmlLines = @(
            '<?xml version="1.0"?>',
            '<Obfuscator>',
            "  <Var name=`"InPath`" value=`"$binRelease`" />",
            "  <Var name=`"OutPath`" value=`"$binRelease`" />",
            '  <Var name="KeepPublicApi" value="true" />',
            '  <Var name="HidePrivateApi" value="true" />',
            '  <Var name="ReuseNames" value="true" />',
            '  <Module file="$(InPath)\*.exe" />',
            '  <Module file="$(InPath)\*.dll">',
            '    <SkipNamespace name="System.*" />',
            '    <SkipNamespace name="Microsoft.*" />',
            '  </Module>',
            '</Obfuscator>'
          )
          
          $configPath = Join-Path $projectDir "obfuscation.xml"
          $xmlLines -join "`n" | Out-File -FilePath $configPath -Encoding UTF8
          
          Write-Host "Archivo de configuracion creado en: $configPath"
          Write-Host "Iniciando obfuscacion de archivos en: $binRelease"
          
          try {
            & $obfuscarPath $configPath
            
            if ($LASTEXITCODE -ne 0) {
              Write-Error "Obfuscacion fallo con codigo: $LASTEXITCODE"
              exit 1
            }
            
            Write-Host "Obfuscacion completada exitosamente"
            
            Write-Host ""
            Write-Host "Archivos ejecutables obfuscados:"
            Get-ChildItem $binRelease -Filter "*.exe" | ForEach-Object {
              Write-Host "  - $($_.Name) - $([math]::Round($_.Length/1KB, 2)) KB"
            }
            
            Write-Host ""
            Write-Host "DLLs obfuscados (excluyendo System y Microsoft):"
            Get-ChildItem $binRelease -Filter "*.dll" | Where-Object { 
              $_.Name -notlike "System.*" -and 
              $_.Name -notlike "Microsoft.*" 
            } | ForEach-Object {
              Write-Host "  - $($_.Name) - $([math]::Round($_.Length/1KB, 2)) KB"
            }
            
          } catch {
            Write-Error "Error durante la obfuscacion: $_"
            Write-Host "Stack trace: $($_.ScriptStackTrace)"
            exit 1
          }

      - name: Build and Publish ClickOnce
        shell: powershell
        run: |
          #$certPath = Resolve-Path '${{ matrix.cert_path }}'
          #$certPasswordPlain = "${{ secrets.CERT_PASSWORD_SALES }}"
          #$securePassword = ConvertTo-SecureString $certPasswordPlain -AsPlainText -Force
          $appVersion = '${{ steps.version.outputs.appVersion }}'

          # Write-Host "Importing certificate from $certPath..."
          # $importedCert = Import-PfxCertificate -FilePath $certPath -CertStoreLocation Cert:\CurrentUser\My -Password $securePassword
          # if (-not $importedCert) {
          #   Write-Error "Certificate import failed."
          #   exit 1
          # }

          # $thumbprint = $importedCert.Thumbprint
          # $subject = $importedCert.Subject
          # Write-Host "Imported certificate: $subject"
          # Write-Host "Thumbprint: $thumbprint"

          Start-Sleep -Seconds 5

          Write-Host "Building ClickOnce package with version $appVersion"

          msbuild '${{ matrix.project_path }}' `
            /t:Publish `
            /p:Configuration='Release' `
            /p:Platform='Any CPU' `
            /p:PublishDir='${{ matrix.publishDir }}' `
            /p:InstallUrl='${{ matrix.installUrl }}' `
            /p:ApplicationVersion="$appVersion" `
            /p:MinimumRequiredVersion="$appVersion" `
            /p:OutputPath='bin\Release' `
            /v:minimal 
            # /p:SignManifests=true `
            # /p:ManifestKeyFile= `
            # /p:ManifestKeyPassword= `
            # /p:ManifestCertificateStoreName="My" `
            # /p:ManifestCertificateSubjectName="$subject" `
            # /p:ManifestCertificateThumbprint="$thumbprint" `
            
      - name: Generate custom publish.htm
        shell: pwsh
        run: |
          $projectPath = "${{ matrix.project_path }}"
          $publishDir = "${{ matrix.publishDir }}"
          $version = "${{ steps.version.outputs.appVersion }}"

          # Leer metadatos desde el .csproj
          [xml]$proj = Get-Content $projectPath
          $propertyGroups = $proj.Project.PropertyGroup

          $appName = ($propertyGroups.ProductName | Where-Object { $_ }) 
          if (-not $appName) { $appName = (Split-Path $projectPath -LeafBase) }

          $publisher = ($propertyGroups.PublisherName | Where-Object { $_ })
          if (-not $publisher) { $publisher = "Gbs International Inc" }

          $framework = ($propertyGroups.TargetFrameworkVersion | Where-Object { $_ })
          if (-not $framework) { $framework = "v4.5.2" }

          # Formatear requisito visible
          $frameworkDisplay = switch -Regex ($framework) {
            "v4.5"   { "Microsoft .NET Framework 4.5 (x86 and x64)" }
            "v4.5.2" { "Microsoft .NET Framework 4.5.2 (x86 and x64)" }
            "v4.6"   { "Microsoft .NET Framework 4.6 (x86 and x64)" }
            "v4.7"   { "Microsoft .NET Framework 4.7 (x86 and x64)" }
            "v4.8"   { "Microsoft .NET Framework 4.8 (x86 and x64)" }
            default  { "Microsoft .NET Framework (x86 and x64)" }
          }

          Write-Host "üì¶ App Name: $appName"
          Write-Host "üè¢ Publisher: $publisher"
          Write-Host "üß© Version: $version"
          Write-Host "üß± Framework: $frameworkDisplay"

          # Asegurar directorio de publicaci√≥n
          if (-not (Test-Path $publishDir)) {
            New-Item -ItemType Directory -Force -Path $publishDir | Out-Null
          }

          # Generar HTML din√°mico
          $html = @"
          <HTML>
          <HEAD>
            <TITLE>${appName}</TITLE>
            <META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=utf-8" />
            <STYLE TYPE="text/css">
          <!--
          BODY{margin-top:20px; margin-left:20px; margin-right:20px; color:#000000; font-family:Tahoma; background-color:white}
          A:link {font-weight:normal; color:#000066; text-decoration:none}
          A:visited {font-weight:normal; color:#000066; text-decoration:none}
          A:active {font-weight:normal; text-decoration:none}
          A:hover {font-weight:normal; color:#FF6600; text-decoration:none}
          P {margin-top:0px; margin-bottom:12px; color:#000000; font-family:Tahoma}
          PRE {border-right:#f0f0e0 1px solid; padding-right:5px; border-top:#f0f0e0 1px solid; margin-top:-5px; padding-left:5px; font-size:x-small; padding-bottom:5px; border-left:#f0f0e0 1px solid; padding-top:5px; border-bottom:#f0f0e0 1px solid; font-family:Courier New; background-color:#e5e5cc}
          TD {font-size:12px; color:#000000; font-family:Tahoma}
          H2 {border-top: #003366 1px solid; margin-top:25px; font-weight:bold; font-size:1.5em; margin-bottom:10px; margin-left:-15px; color:#003366}
          H3 {margin-top:10px; font-size: 1.1em; margin-bottom: 10px; margin-left: -15px; color: #000000}
          UL {margin-top:10px; margin-left:20px}
          OL {margin-top:10px; margin-left:20px}
          LI {margin-top:10px; color: #000000}
          FONT.value {font-weight:bold; color:darkblue}
          FONT.key {font-weight: bold; color: darkgreen}
          .divTag {border:1px; border-style:solid; background-color:#FFFFFF; text-decoration:none; height:auto; width:auto; background-color:#cecece}
          .BannerColumn {background-color:#000000}
          .Banner {border:0; padding:0; height:8px; margin-top:0px; color:#ffffff; filter:progid:DXImageTransform.Microsoft.Gradient(GradientType=1,StartColorStr='#1c5280',EndColorStr='#FFFFFF');}
          .BannerTextCompany {font:bold; font-size:18pt; color:#cecece; font-family:Tahoma; height:0px; margin-top:0; margin-left:8px; margin-bottom:0; padding:0px; white-space:nowrap; filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2,OffY=2,Color='black',Positive='true');}
          .BannerTextApplication {font:bold; font-size:18pt; font-family:Tahoma; height:0px; margin-top:0; margin-left:8px; margin-bottom:0; padding:0px; white-space:nowrap; filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2,OffY=2,Color='black',Positive='true');}
          .BannerText {font:bold; font-size:18pt; font-family:Tahoma; height:0px; margin-top:0; margin-left:8px; margin-bottom:0; padding:0px; filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2,OffY=2,Color='black',Positive='true');}
          .BannerSubhead {border:0; padding:0; height:16px; margin-top:0px; margin-left:10px; color:#ffffff; filter:progid:DXImageTransform.Microsoft.Gradient(GradientType=1,StartColorStr='#4B3E1A',EndColorStr='#FFFFFF');}
          .BannerSubheadText {font:bold; height:11px; font-size:11px; font-family:Tahoma; margin-top:1; margin-left:10; filter:progid:DXImageTransform.Microsoft.dropshadow(OffX=2,OffY=2,Color='black',Positive='true');}
          .FooterRule {border:0; padding:0; height:1px; margin:0px; color:#ffffff; filter:progid:DXImageTransform.Microsoft.Gradient(GradientType=1,StartColorStr='#4B3E1A',EndColorStr='#FFFFFF');}
          .FooterText {font-size:11px; font-weight:normal; text-decoration:none; font-family:Tahoma; margin-top:10; margin-left:0px; margin-bottom:2; padding:0px; color:#999999; white-space:nowrap}
          .FooterText A:link {font-weight:normal; color:#999999; text-decoration:underline}
          .FooterText A:visited {font-weight:normal; color:#999999; text-decoration:underline}
          .FooterText A:active {font-weight:normal; text-decoration:underline}
          .FooterText A:hover {font-weight:normal; color:#FF6600; text-decoration:underline}
          .ClickOnceInfoText {font-size:11px; font-weight:normal; text-decoration:none; font-family:Tahoma; margin-top:0; margin-right:2px; margin-bottom:0; padding:0px; color:#000000}
          .InstallTextStyle {font:bold; font-size:14pt; font-family:Tahoma; a:#FF0000; text-decoration:None}
          .DetailsStyle {margin-left:30px}
          .ItemStyle {margin-left:-15px; font-weight:bold}
          .StartColorStr {background-color:#4B3E1A}
          .JustThisApp A:link {font-weight:normal; color:#000066; text-decoration:underline}
          .JustThisApp A:visited {font-weight:normal; color:#000066; text-decoration:underline}
          .JustThisApp A:active {font-weight:normal; text-decoration:underline}
          .JustThisApp A:hover {font-weight:normal; color:#FF6600; text-decoration:underline}
          -->

          </STYLE>

          <SCRIPT LANGUAGE="JavaScript">
          <!--
          runtimeVersion = "${framework}";
          checkClient = false;
          directLink = "${appName}.application";
          -->
          </SCRIPT>

          </HEAD>
            <BODY ONLOAD="Initialize()">
              <TABLE WIDTH="100%" CELLPADDING="0" CELLSPACING="2" BORDER="0">

          <!-- Begin Banner -->
          <TR><TD><TABLE CELLPADDING="2" CELLSPACING="0" BORDER="0" BGCOLOR="#cecece" WIDTH="100%"><TR><TD><TABLE BGCOLOR="#1c5280" WIDTH="100%" CELLPADDING="0" CELLSPACING="0" BORDER="0"><TR><TD CLASS="Banner" /></TR><TR><TD CLASS="Banner"><SPAN CLASS="BannerTextCompany">${publisher}</SPAN></TD></TR><TR><TD CLASS="Banner"><SPAN CLASS="BannerTextApplication">${appName}</SPAN></TD></TR><TR><TD CLASS="Banner" ALIGN="RIGHT" /></TR></TABLE></TD></TR></TABLE></TD></TR>
          <!-- End Banner -->


          <!-- Begin Dialog -->
          <TR><TD ALIGN="LEFT"><TABLE CELLPADDING="2" CELLSPACING="0" BORDER="0" WIDTH="540"><TR><TD WIDTH="496">

          <!-- Begin AppInfo -->
          <TABLE><TR><TD COLSPAN="3">&nbsp;</TD></TR><TR><TD><B>Name:</B></TD><TD WIDTH="5"><SPACER TYPE="block" WIDTH="10" /></TD><TD>${appName}</TD></TR><TR><TD COLSPAN="3">&nbsp;</TD></TR><TR><TD><B>Version:</B></TD><TD WIDTH="5"><SPACER TYPE="block" WIDTH="10" /></TD><TD>${version}</TD></TR><TR><TD COLSPAN="3">&nbsp;</TD></TR><TR><TD><B>Publisher:</B></TD><TD WIDTH="5"><SPACER TYPE="block" WIDTH="10" /></TD><TD>${publisher}</TD></TR><tr><td colspan="3">&nbsp;</td></tr></TABLE>
          <!-- End AppInfo -->


          <!-- Begin Prerequisites -->
          <TABLE ID="BootstrapperSection" BORDER="0"><TR><TD COLSPAN="2">The following prerequisites are required:</TD></TR><TR><TD WIDTH="10">&nbsp;</TD><TD><UL>
          <LI>${frameworkDisplay}</LI>
          </UL></TD></TR><TR><TD COLSPAN="2">
          If these components are already installed, you can <SPAN CLASS="JustThisApp"><A HREF="${appName}.application">launch</A></SPAN> the application now. Otherwise, click the button below to install the prerequisites and run the application.
          </TD></TR><TR><TD COLSPAN="2">&nbsp;</TD></TR></TABLE>
          <!-- End Prerequisites -->


          </TD></TR></TABLE>
          <!-- Begin Buttons -->
          <TR><TD ALIGN="LEFT"><TABLE CELLPADDING="2" CELLSPACING="0" BORDER="0" WIDTH="540" STYLE="cursor:hand" ONCLICK="window.navigate(InstallButton.href)"><TR><TD ALIGN="LEFT"><TABLE CELLPADDING="1" BGCOLOR="#333333" CELLSPACING="0" BORDER="0"><TR><TD><TABLE CELLPADDING="1" BGCOLOR="#cecece" CELLSPACING="0" BORDER="0"><TR><TD><TABLE CELLPADDING="1" BGCOLOR="#efefef" CELLSPACING="0" BORDER="0"><TR><TD WIDTH="20"><SPACER TYPE="block" WIDTH="20" HEIGHT="1" /></TD><TD><A ID="InstallButton" HREF="setup.exe">Install</A></TD><TD width="20"><SPACER TYPE="block" WIDTH="20" HEIGHT="1" /></TD></TR></TABLE></TD></TR></TABLE></TD></TR></TABLE></TD><TD WIDTH="15%" ALIGN="right" /></TR></TABLE></TD></TR>
          <!-- End Buttons -->
          </TD></TR>
          <!-- End Dialog -->



          <!-- Spacer Row -->
          <TR><TD>&nbsp;</TD></TR>

          <TR><TD>
          <!-- Begin Footer -->
          <TABLE WIDTH="100%" CELLPADDING="0" CELLSPACING="0" BORDER="0" BGCOLOR="#ffffff"><TR><TD HEIGHT="5"><SPACER TYPE="block" HEIGHT="5" /></TD></TR><TR><TD CLASS="FooterText" ALIGN="center"><A HREF="https://go.microsoft.com/fwlink/?LinkId=154571">ClickOnce and .NET Framework Resources</A>
          </TD></TR><TR><TD HEIGHT="5"><SPACER TYPE="block" HEIGHT="5" /></TD></TR><TR><TD HEIGHT="1" bgcolor="#cecece"><SPACER TYPE="block" HEIGHT="1" /></TD></TR></TABLE>
          <!-- End Footer -->
          </TD></TR>

          </TABLE>
            </BODY>
          </HTML>

          "@

          $outputFile = Join-Path $publishDir "publish.htm"
          $html | Out-File -FilePath $outputFile -Encoding UTF8 -Force
          Write-Host "‚úÖ Custom publish.htm generated at: $outputFile"


      - name: Update MSI Version and GUIDs
        shell: pwsh
        run: |
          $vdprojPath = '${{ matrix.msi_project_path }}'
          $fullVersion = '${{ steps.version.outputs.appVersion }}'

          if (-not (Test-Path $vdprojPath)) {
            Write-Error "‚ùå No se encontr√≥ el archivo .vdproj en la ruta $vdprojPath"
            exit 1
          }

          Write-Host "üîç Actualizando versi√≥n del MSI usando: $fullVersion"

          # Extraer partes de la versi√≥n completa (YYYY.MM.DD.RUN)
          $parts = $fullVersion -split '\.'
          if ($parts.Length -lt 3) {
            Write-Error "‚ö†Ô∏è Formato de versi√≥n inesperado: $fullVersion"
            exit 1
          }

          $shortYear = $parts[0][-2..-1] -join ''   # "25"
          $month = $parts[1].PadLeft(2, '0')        # "11"

          $dayInt = [int]$parts[2]                  # D√≠a (ej: 20)
          $runInt = if ($parts.Length -ge 4) { [int]$parts[3] } else { 1 }

          # C√°lculo del bloque final (d√≠a * 10 + corrida)
          # Ejemplo: d√≠a=20, corrida=1 ‚Üí 201
          $numericLastBlock = ($dayInt * 10) + $runInt
          if ($numericLastBlock -gt 999) {
            Write-Error "üö® El bloque final del ProductVersion excede el l√≠mite (999). Valor: $numericLastBlock"
            exit 1
          }

          $lastBlock = "{0:D3}" -f $numericLastBlock
          $newVersion = "$shortYear.$month.$lastBlock"

          Write-Host "üß© Nueva versi√≥n MSI: $newVersion"

          # Generar nuevos GUIDs
          $newProductCode = [guid]::NewGuid().ToString().ToUpper()
          $newPackageCode = [guid]::NewGuid().ToString().ToUpper()

          Write-Host "üÜï ProductCode: {$newProductCode}"
          Write-Host "üÜï PackageCode: {$newPackageCode}"

          # Leer y reemplazar en el archivo .vdproj
          $content = Get-Content $vdprojPath -Raw

          $content = $content -replace '"ProductVersion" = "8:[^"]+"', "`"ProductVersion`" = `"8:$newVersion`""
          $content = $content -replace '"ProductCode" = "8:{[^}]+}"', "`"ProductCode`" = `"8:{$newProductCode}`""
          $content = $content -replace '"PackageCode" = "8:{[^}]+}"', "`"PackageCode`" = `"8:{$newPackageCode}`""

          $content | Set-Content $vdprojPath -Encoding UTF8

          Write-Host "‚úÖ Archivo .vdproj actualizado correctamente"
          Write-Host "üì¶ ProductVersion: $newVersion"
          Write-Host "üß± ProductCode y PackageCode regenerados"


      - name: Build MSI Installer
        shell: powershell
        run: |
          # Ruta absoluta al devenv.com (necesario para buildear .vdproj)
          $devenv = "C:\Program Files\Microsoft Visual Studio\2022\Community\Common7\IDE\devenv.com"

          if (-not (Test-Path $devenv)) {
            Write-Error "Visual Studio 2022 Community con Installer Projects no est√° instalado."
            exit 1
          }

          # Rutas
          $slnPath = (Resolve-Path "${{ matrix.sln_path }}").Path
          $msiPath = (Resolve-Path "${{ matrix.msi_project_path }}").Path
          $outputDir = "C:\test\msi"

          Write-Host "Building MSI from $projectPath"
          New-Item -ItemType Directory -Force -Path $outputDir | Out-Null

          # Ejecutar build del proyecto MSI
          & "$devenv" "$slnPath" /Build "Release" /Project $msiPath

          if ($LASTEXITCODE -ne 0) {
            Write-Error "MSI build failed."
            exit 1
          }

          Write-Host "MSI successfully built. Contents:"
          Get-ChildItem -Path $outputDir -Filter *.msi -Recurse | Select-Object FullName
            
      - name: Upload ClickOnce artifact
        uses: actions/upload-artifact@v4
        env:
          NODE_TLS_REJECT_UNAUTHORIZED: '0'
        with:
          name: ClickOnce-Package
          path: |
            ${{ matrix.publishDir }}/**
          if-no-files-found: error

      
      - name: Navegando MSI installer path
        shell: powershell
        id: find_msi
        run: |
          # Derivar carpeta base del proyecto MSI
          $msiProjectPath = "${{ matrix.msi_project_path }}"
          $msiDir = Split-Path $msiProjectPath -Parent
          $releaseDir = Join-Path $msiDir "Release"

          Write-Host "Searching for MSI files in: $releaseDir"

          if (-not (Test-Path $releaseDir)) {
            Write-Error "Release directory not found: $releaseDir"
            exit 1
          }

          $msiFiles = Get-ChildItem -Path $releaseDir -Filter *.msi -Recurse
          if (-not $msiFiles) {
            Write-Error "No MSI files found in $releaseDir"
            exit 1
          }

          Write-Host "Found the following MSI files:"
          $msiFiles | ForEach-Object { Write-Host " - $($_.FullName)" }

          echo "releaseDir=$releaseDir" >> $env:GITHUB_OUTPUT

      - name: Upload MSI artifact
        uses: actions/upload-artifact@v4
        env:
          NODE_TLS_REJECT_UNAUTHORIZED: '0'
        with:
          name: MSI-Installer
          path: |
            ${{ steps.find_msi.outputs.releaseDir }}/*.msi
          if-no-files-found: error

  # backup_installers:
  #   name: "üóÇÔ∏è Backup Installers"
  #   runs-on: ${{ fromJson(inputs.runner_tag) }}
  #   needs: build_clickonce
  #   strategy:
  #     matrix: ${{ fromJson(inputs.projects_json) }}
  #     max-parallel: 1
  #   steps:
  #     - name: "Prepare Backup Folder"
  #       uses: PruebaActions/WorkFlows-Templates/.github/actions/create-backup@main
  #       with:
  #         deploy_target_path: ${{ matrix.deploy_target_path }}

  # deploy_installers:
  #   name: "üöÄ Deploy Installers"
  #   needs: backup_installers
  #   runs-on: ${{ fromJson(inputs.runner_tag) }}
  #   strategy:
  #     matrix: ${{ fromJson(inputs.projects_json) }}
  #     max-parallel: 1

  #   steps:
  #     - uses: actions/checkout@v4

  #     - name: "Downloading artifacts"
  #       uses: actions/download-artifact@v4
  #       env:
  #         NODE_TLS_REJECT_UNAUTHORIZED: '0'
  #       with:
  #         name: ${{ matrix.artifact_name}}
  #         path: ${{ github.workspace }}/artifact/${{ matrix.artifact_name}}

  #     - name: "Deploy to IIS"
  #       uses: PruebaActions/WorkFlows-Templates/.github/actions/deploy-to-iis@main
  #       with:
  #         project_name: ${{ matrix.project_name }}
  #         publish_path: ${{ github.workspace }}/artifact/${{ matrix.artifact_name }}
  #         destination_path: ${{ matrix.deploy_target_path }}
  #         skip_items_json: ${{ inputs.skip_items_json }}

      
