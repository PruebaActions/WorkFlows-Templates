name: Pull Request Pipeline .NET + CodeQL + OWASP ZAP

on:
  workflow_call:
    inputs:
      image_name:
        description: "Nombre de la imagen Docker"
        required: true
        type: string
      container_name:
        description: "Nombre del contenedor Docker"
        required: true
        type: string
      dockerfile:
        description: "Ruta al Dockerfile"
        default: "./Dockerfile"
        required: true
        type: string
      container_port:
        description: "Puerto expuesto por la aplicaciÃ³n"
        default: "8080"
        type: string
      host_port:
        description: "Puerto en la HOST machine"
        type: string
        default: "4200"
      codeql_languages:
        description: "Lenguajes a analizar con CodeQL"
        default: "csharp"
        type: string
      project_paths:
        description: "Lista JSON de proyectos a compilar"
        required: true
        type: string
      has_tests: 
        description: "Confirmacion de si la app tiene tests"
        type: boolean
        required: true

jobs:
  build-and-test:
    runs-on: 
      group: DAST
    strategy:
      matrix:
        project: ${{ fromJSON(inputs.project_paths) }}
    steps:
      - uses: actions/checkout@v4
      - uses: PruebaActions/Workflows-Templates/.github/actions/build-and-test@main
        with:
          project_path: ${{ matrix.project }}
          has_tests: ${{ inputs.has_tests }}

  # ðŸ”¹ Build & Run App en Docker
  docker-set-up:
    runs-on:
      group: DAST
    steps:
      - uses: actions/checkout@v4
      - uses: PruebaActions/WorkFlows-Templates/.github/actions/docker-set-up@main
        with:
          image_name: ${{ inputs.image_name }}
          container_name: ${{ inputs.container_name }}
          dockerfile: ${{ inputs.dockerfile }}
          host_port: ${{ inputs.host_port }}
          container_port: ${{ inputs.container_port }}

  # ðŸ”¹ CodeQL Analysis (SAST)
 # codeql-analysis:
  #  runs-on:
   #     group: DAST
  #  needs: docker-set-up
   # permissions:
   #   actions: read
   #   contents: read
   #   security-events: write
   # steps:
    #  - uses: actions/checkout@v4
     # - name: Initialize CodeQL
    #    uses: github/codeql-action/init@v3
    #    with:
   #       languages: ${{ inputs.codeql_languages }}
   #   - name: Autobuild
   #     uses: github/codeql-action/autobuild@v3
   #   - name: Perform CodeQL Analysis
   #     uses: github/codeql-action/analyze@v3

  # ðŸ”¹ OWASP ZAP Scan (DAST)
  dast-scan:
    runs-on:
      group: DAST
    needs: docker-set-up
    steps:
      - name: Run OWASP ZAP Baseline Scan
        uses: zaproxy/action-baseline@v0.14.0
        with:
          target: "http://localhost:${{ inputs.host_port }}"
          artifact_name: 'drop'

  delete-container:
    runs-on:
      group: DAST
    needs: dast-scan
    steps:
      - uses: actions/checkout@v4
      - uses: PruebaActions/WorkFlows-Templates/.github/actions/stop-and-remove-docker@main
        with:
          image_name: ${{ inputs.image_name }}
          container_name: ${{ inputs.container_name }}
