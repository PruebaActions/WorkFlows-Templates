name: Check Multiple Path Changes

on:
  workflow_call:
    inputs:
      paths:
        description: "Lista JSON o separada por comas de rutas a verificar"
        required: true
        type: string
    outputs:
      all_changed:
        description: "True si todos los paths tienen cambios"
        value: ${{ jobs.check-changes.outputs.all_changed }}

jobs:
  check-changes:
    runs-on: windows-latest
    outputs:
      all_changed: ${{ steps.check.outputs.all_changed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check changes dynamically
        id: check
        shell: pwsh
        run: |
          # Obtener commits actuales
          $commitBefore = "${{ github.event.before }}"
          $commitCurrent = "${{ github.sha }}"

          if (-not $commitBefore -or -not $commitCurrent) {
            Write-Host "Commits invÃ¡lidos, no se puede continuar."
            echo "all_changed=false" >> $env:GITHUB_OUTPUT
            exit 0
          }

          Write-Host "Comparando cambios entre $commitBefore y $commitCurrent..."
          $changedFiles = git diff --name-only $commitBefore $commitCurrent
          Write-Host "`nArchivos modificados:`n$changedFiles`n"

          # Convertir el input en una lista (acepta JSON o CSV)
          $rawInput = '${{ inputs.paths }}'
          if ($rawInput.Trim().StartsWith('[')) {
            $paths = ConvertFrom-Json $rawInput
          } else {
            $paths = $rawInput.Split(',') | ForEach-Object { $_.Trim() }
          }

          Write-Host "Paths a verificar:"
          $paths | ForEach-Object { Write-Host " - $_" }

          $allChanged = $true

          foreach ($path in $paths) {
            $pattern = $path -replace '\*\*','.*' -replace '\*','[^/\\]*'
            $match = $changedFiles | Where-Object { $_ -match $pattern }

            if (-not $match) {
              Write-Host "No hubo cambios en: $path"
              $allChanged = $false
            } else {
              Write-Host "Cambios detectados en: $path"
            }
          }

          if ($allChanged) {
            Write-Host "Todos los paths tuvieron cambios."
          } else {
            Write-Host "No todos los paths cambiaron."
          }

          echo "all_changed=$allChanged" >> $env:GITHUB_OUTPUT
